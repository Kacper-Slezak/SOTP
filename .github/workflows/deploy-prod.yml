# .github/workflows/deploy-prod.yml - Build & Package Release
#
# âš ï¸ UWAGA: Ten workflow NIE deployuje na serwer (jeszcze nie mamy infrastruktury)
# Cel: ZbudowaÄ‡ i opublikowaÄ‡ obraz Docker dla przyszÅ‚ego uÅ¼ycia
#
# Uruchamia siÄ™ TYLKO gdy utworzysz tag: git tag v1.0.0 && git push origin v1.0.0

name: ðŸ“¦ Build Release

on:
  push:
    tags:
      - 'v*' # v1.0.0, v1.1.0, itp.

permissions:
  contents: read
  packages: write  # Potrzebne do pushowania do GitHub Container Registry

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ===================================================================
  # JOB 1: BUILD & PUBLISH - Zbuduj i wypchnij obraz Docker
  # ===================================================================
  build_and_publish:
    name: ðŸ³ Build & Publish Docker Image
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ·ï¸ Extract Version from Tag
        id: version
        run: |
          # Z taga v1.2.0 wyciÄ…gamy 1.2.0
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Building version: $VERSION"

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ³ Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true  # Pushuj do GitHub Container Registry
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.title=SOTP
            org.opencontainers.image.version=${{ steps.version.outputs.VERSION }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: âœ… Build Summary
        run: |
          echo "==================================="
          echo "ðŸŽ‰ Docker Image Published!"
          echo "==================================="
          echo "ðŸ“¦ Version: ${{ steps.version.outputs.VERSION }}"
          echo "ðŸ·ï¸ Tag: ${{ github.ref_name }}"
          echo "ðŸ³ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          echo ""
          echo "Available tags:"
          echo "  - latest"
          echo "  - ${{ steps.version.outputs.VERSION }}"
          echo ""
          echo "ðŸ”— View at: https://github.com/${{ github.repository }}/pkgs/container/${{ github.event.repository.name }}"
          echo "==================================="

  # ===================================================================
  # JOB 2: CREATE RELEASE NOTES - StwÃ³rz release notes na GitHubie
  # ===================================================================
  create_release:
    name: ðŸ“ Create GitHub Release
    runs-on: ubuntu-latest
    needs: build_and_publish
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Pobierz caÅ‚Ä… historiÄ™ (dla changelog)

      - name: ðŸ·ï¸ Extract Version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: ðŸ“ Generate Changelog
        id: changelog
        run: |
          # ZnajdÅº poprzedni tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "First release - no previous tag found"
            CHANGELOG="ðŸŽ‰ Initial release of SOTP v${{ steps.version.outputs.VERSION }}"
          else
            echo "Generating changelog from $PREVIOUS_TAG to ${{ github.ref_name }}"

            # Generuj changelog z commitÃ³w
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)

            # Dodaj header
            CHANGELOG="## Changes since ${PREVIOUS_TAG}"$'\n\n'"${CHANGELOG}"
          fi

          # Zapisz do pliku (GitHub Actions ma problem z multi-line w GITHUB_OUTPUT)
          echo "$CHANGELOG" > changelog.txt

      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body_path: changelog.txt
          draft: false
          prerelease: false
          generate_release_notes: true  # GitHub automatycznie doda release notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===================================================================
  # JOB 3: NOTIFY - Powiadomienie na Discord
  # ===================================================================
  notify:
    name: ðŸ“¢ Notify Release Status
    needs: [build_and_publish, create_release]
    if: always()
    uses: ./.github/workflows/discord_notifier.yml
    with:
      status: ${{ needs.build_and_publish.result == 'success' && needs.create_release.result == 'success' && 'success' || 'failure' }}
      environment: Release Build
      commit_sha: ${{ github.sha }}
      actor: ${{ github.actor }}
      version: ${{ github.ref_name }}
      deployment_url: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}
    secrets:
      webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}

# ===================================================================
# ðŸ“š JAK TEGO UÅ»YWAÄ†?
# ===================================================================
#
# 1. ZakoÅ„cz pracÄ™ nad wersjÄ… 1.0.0
# 2. UtwÃ³rz tag:
#    git tag v1.0.0 -m "Release version 1.0.0"
#    git push origin v1.0.0
#
# 3. Workflow automatycznie:
#    âœ… Zbuduje obraz Docker
#    âœ… WypchnÄ…Å‚ do GitHub Container Registry
#    âœ… Utworzy Release na GitHubie
#    âœ… WyÅ›le powiadomienie na Discord
#
# 4. W przyszÅ‚oÅ›ci gdy bÄ™dziesz miaÅ‚ serwer produkcyjny:
#    - Dodaj job "deploy" z SSH deployment
#    - Dodaj smoke tests
#    - BÄ™dzie gotowy do uÅ¼ycia!
#
# ===================================================================
