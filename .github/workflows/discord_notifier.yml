# .github/workflows/discord_notifier.yml - Reusable notifier with support for warnings

name: Reusable Discord Notifier
on:
  workflow_call:
    inputs:
      status: { required: true, type: string }
      pytest_exit_code: { required: false, type: string } # New input for test status
      environment: { required: true, type: string }
      commit_sha: { required: true, type: string }
      actor: { required: true, type: string }
    secrets:
      webhook_url: { required: true }

jobs:
  send_notification:
    name: Send Discord Notification
    runs-on: ubuntu-latest
    steps:
      - name: Prepare Variables and Message
        id: vars
        run: |
          # Case 1: Pytest exit code is 5 (no tests found) -> This is a WARNING
          if [ "${{ inputs.pytest_exit_code }}" == "5" ]; then
            echo "TITLE=CI Pipeline OSTRZE≈ªENIE" >> $GITHUB_OUTPUT
            echo "COLOR=16705372" >> $GITHUB_OUTPUT # Yellow
            echo "DESCRIPTION=Pipeline CI dla **${{ inputs.environment }}** zako≈Ñczony, ale **nie znaleziono ≈ºadnych test√≥w backendu**. Nale≈ºy je dodaƒá." >> $GITHUB_OUTPUT
            echo "EMOJI=‚ö†Ô∏è" >> $GITHUB_OUTPUT
          # Case 2: The overall job status is 'success'
          elif [ "${{ inputs.status }}" == "success" ]; then
            echo "TITLE=CI Pipeline SUKCES" >> $GITHUB_OUTPUT
            echo "COLOR=3066993" >> $GITHUB_OUTPUT # Green
            echo "DESCRIPTION=Wszystkie kroki CI (Lint, Test, Build) dla **${{ inputs.environment }}** zako≈Ñczy≈Çy siƒô pomy≈õlnie." >> $GITHUB_OUTPUT
            echo "EMOJI=‚úÖ" >> $GITHUB_OUTPUT
          # Case 3: Any other case is a FAILURE
          else
            echo "TITLE=CI Pipeline B≈ÅƒÑD" >> $GITHUB_OUTPUT
            echo "COLOR=15158332" >> $GITHUB_OUTPUT # Red
            echo "DESCRIPTION=Pipeline CI dla **${{ inputs.environment }}** ZAWI√ìD≈Å! üö® Wymagana interwencja." >> $GITHUB_OUTPUT
            echo "EMOJI=‚ùå" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord Webhook
        run: |
          curl -H "Content-Type: application/json" \
               -d '{
                 "embeds": [
                   {
                     "title": "${{ steps.vars.outputs.EMOJI }} ${{ steps.vars.outputs.TITLE }}",
                     "description": "${{ steps.vars.outputs.DESCRIPTION }}",
                     "color": ${{ steps.vars.outputs.COLOR }},
                     "fields": [
                       {
                         "name": "≈örodowisko",
                         "value": "${{ inputs.environment }}",
                         "inline": true
                       },
                       {
                         "name": "Commit",
                         "value": "[`${{ inputs.commit_sha }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ inputs.commit_sha }})",
                         "inline": true
                       },
                       {
                         "name": "Wykonawca",
                         "value": "${{ inputs.actor }}",
                         "inline": true
                       },
                       {
                         "name": "Repository",
                         "value": "[${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})",
                         "inline": false
                       },
                       {
                         "name": "Workflow Run",
                         "value": "[Zobacz szczeg√≥≈Çy](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})",
                         "inline": false
                       }
                     ],
                     "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'",
                     "footer": {
                       "text": "GitHub Actions",
                       "icon_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                     }
                   }
                 ]
               }' \
               "${{ secrets.webhook_url }}"