# Makefile dla projektu SOTP - Wersja Docker-First
# UÅ¼yj `make` lub `make help` aby wyÅ›wietliÄ‡ dostÄ™pne komendy.

# Zmienne
DOCKER_COMPOSE_DEV = docker-compose --env-file ./.env -f infrastructure/docker/docker-compose.dev.yml
DOCKER_COMPOSE_PROD = docker-compose --env-file ./.env -f infrastructure/docker/docker-compose.prod.yml

.PHONY: help dev up down logs shell-backend shell-frontend test setup build push deploy clean

help:
	@echo "DostÄ™pne komendy dla projektu SOTP (tryb Docker-First):"
	@echo ""
	@echo "--- GÅ‚Ã³wne (Docker Dev) ---"
	@echo "  make dev           -> Uruchamia peÅ‚ne Å›rodowisko deweloperskie w tle (alias dla 'up')."
	@echo "  make up            -> Buduje i uruchamia kontenery deweloperskie w tle."
	@echo "  make down          -> Zatrzymuje i usuwa kontenery deweloperskie."
	@echo "  make logs          -> WyÅ›wietla logi ze wszystkich dziaÅ‚ajÄ…cych kontenerÃ³w."
	@echo "  make shell-backend -> Otwiera powÅ‚okÄ™ (bash) w kontenerze backendu."
	@echo "  make shell-frontend-> Otwiera powÅ‚okÄ™ (sh) w kontenerze frontendu."
	@echo "  make test          -> Uruchamia testy backendu (pytest) wewnÄ…trz kontenera."
	@echo ""
	@echo "--- Produkcja i WdroÅ¼enie ---"
	@echo "  make build         -> Buduje produkcyjne obrazy Docker."
	@echo "  make push          -> WysyÅ‚a zbudowane obrazy do repozytorium (np. Docker Hub)."
	@echo "  make deploy        -> Symuluje wdroÅ¼enie aplikacji na serwerze."
	@echo ""
	@echo "--- NarzÄ™dzia i Utrzymanie ---"
	@echo "  make clean         -> Zatrzymuje kontenery i usuwa wszystkie dane (wolumeny)."
	@echo "  make setup         -> (Lokalnie) Instaluje zaleÅ¼noÅ›ci w lokalnym venv/npm."
	@echo ""

# === Sekcja GÅ‚Ã³wna (Docker Dev) ===
dev: up

up:
	@echo "ğŸš€  Uruchamianie peÅ‚nego Å›rodowiska deweloperskiego Docker..."
	$(DOCKER_COMPOSE_DEV) up --build -d

down:
	@echo "ğŸ›‘  Zatzymywanie Å›rodowiska deweloperskiego Docker..."
	$(DOCKER_COMPOSE_DEV) down

logs:
	@echo "ğŸ“œ  WyÅ›wietlanie logÃ³w dla wszystkich usÅ‚ug... (NaciÅ›nij Ctrl+C aby zakoÅ„czyÄ‡)"
	$(DOCKER_COMPOSE_DEV) logs -f

shell-backend:
	@echo "ğŸ’»  Otwieranie powÅ‚oki w kontenerze backendu..."
	$(DOCKER_COMPOSE_DEV) exec backend bash

shell-frontend:
	@echo "ğŸ’»  Otwieranie powÅ‚oki w kontenerze frontendu..."
	$(DOCKER_COMPOSE_DEV) exec frontend sh

test:
	@echo "ğŸ§ª  Uruchamianie testÃ³w backendu w kontenerze Docker..."
	$(DOCKER_COMPOSE_DEV) exec backend pytest

# === Sekcja Produkcja i WdroÅ¼enie ===
build:
	@echo "ğŸ“¦  Budowanie produkcyjnych obrazÃ³w Docker..."
	$(DOCKER_COMPOSE_PROD) build

push:
	@echo "â«  WysyÅ‚anie obrazÃ³w do repozytorium..."
	$(DOCKER_COMPOSE_PROD) push

deploy:
	@echo "ğŸš¢  WdraÅ¼anie aplikacji na serwerze..."
	@echo "Ta komenda na serwerze produkcyjnym uruchomiÅ‚aby: docker-compose -f infrastructure/docker/docker-compose.prod.yml up -d"

# === Sekcja NarzÄ™dzia i Utrzymanie ===
clean:
	@echo "ğŸ”¥  Zatrzymywanie kontenerÃ³w i usuwanie wszystkich danych (wolumenÃ³w)..."
	$(DOCKER_COMPOSE_DEV) down -v

# === Sekcja Development (Lokalnie z VENV - opcjonalnie) ===
setup:
	@echo "ğŸ› ï¸  (Lokalnie) Instalowanie zaleÅ¼noÅ›ci backendu w venv..."
	(cd backend && python -m venv venv && . venv/bin/activate && pip install -r requirements.txt)
	@echo "ğŸ› ï¸  (Lokalnie) Instalowanie zaleÅ¼noÅ›ci frontendu z npm..."
	(cd frontend && npm install)
	@echo "âœ… Setup lokalny zakoÅ„czony. PamiÄ™taj, aby aktywowaÄ‡ venv dla backendu."